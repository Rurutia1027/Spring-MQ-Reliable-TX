# Flexible Transactions 

## Service Modes in Flexible Transactions 

### Queryable Operations 
- Operations should be traceable and have a globally unique identifier for tracking execution results. 

#### Service Operation Identifiability 
##### Using a Business Document Number 
- Example: Order ID (e.g., an e-commerce order number)
- Ensures that each transaction is linked to a specific business event. 

##### Using a System-Assigned Operation Serial Number 
- Example: Payment Transaction ID (e.g., a unique identifier assigned by a payment system)
- Generated by the system to track operations in an independent manner. 

##### Using a Combination of Operation Resources 
- Example: Merchange ID + Merchant Order ID 
- This approach is useful when multiple system interact and no single system controls the identifier. 

#### Additional Requirements 
- Uniqueness: Each identifier must be globally unique across the distributed system. 
- Deterministic Timestamp: Each operation must have a well-defined timestamp, with a clear agreement on which system's time reference is authoritative (e.g., database time, service time, or an external NTP source). 

This ensures that **operations are tracable**, **auditable**, and **replayable** when necessary. 


#### Single Operation Query 
A single operation query allows retrieving the execution result of a specific transaction using a **globally unique service operation identifier**. 

##### Use a Global Unique Service Operation Identifier 
- The query must be based on a **unique identifier** (e.g., Order ID, Payment Transaction ID, or a composite key like Merchant ID + Order ID). 
- Ensures precise tracking of a specific operation in a distributed system. 

##### Query the Execution Result of the Operation 
- The system should return the **final state** of the operation (e.g., Success, Failure).
- Ensures that the result can be **reproduced** when needed. 

##### Handle "Processing" Status with Caution 
- If the operation is in a "Processing" state, additional care is required. 
  - Implement **timeout and retry machanisms** to prevent indefinite waiting. 
  - Use **idempotent mechanisms** to ensure safe re-execution of queries. 
  - Consider notifying the client with a **pending response strategy**. 

This approach ensures that a **single operation query remains reliable and consistent** in a distributed system. 

#### Batch Query 
A batch query retrieves execution results for multiple operations by using **a time range and a group of service operation identifiers**. 

##### Use a Time Range and a Set of Service Operation Identifiers
##### Retrieve Execution Results for Multiple Operations 
##### Efficient Data Processing 

### Idempotent Operations
- Ensuring that repeated execution of the same operation produces the same result, preventing unintended side effects. 

#### Key Points: 
- Definition: 
  - Calling an operation once or multiple times produces the same result. 
- Implementation Approaches:
  - The business logic or the service itself is designed to handle repeated requests and ensures that the same result is returned.
  - The system can cache or store the result of the first request, and if it detects duplicate requests, it can simply return the cached result.  

### TCC Operations (Try-Confirm-Cancel)
- A transactional consistency approach involving a **Try** phase (reservation of resources), a **Confirm** phase (commit changes), and a **Cancel** phase (rollback in case of failure). 

#### Try: Attempt to Execute Business Logic 
- Complete all business checks(ensure consistency).
- Reserve necessary business resources (isolation).

#### Confirm: Confirm Execution of Business Logic 
- Actually execute the business operation. 
- No additional business checks are performed. 
- Uses only the reserved resources from the Try phase. 
- Confirm operations must be **idempotent**(repeatable without side effects).

#### Cancel: Rollback Business Execution 
- Release the reserved business resources from the Try phase. 
- Cancel operations must also be **idempotent**. 


#### Comparisions with 2PC Protocol 
- Operates at the **business service layer** rather than the **resource layer**. 
- No separate **Prepare phase**; the Try phase handles both resources reservation and preparation. 
- Try operations allow flexible control over **locking granularity** (business-level, not resource-level).


#### Common Misunderstanding 
Many assume that **TCC is the same as 2PC**, but in reality, TCC is a type of **two-phase operation model** with a different focus.  



### Compensable Operations
- Allowing operations to be reversed or compensated in case of failure, commonly used in long-running business processes. 